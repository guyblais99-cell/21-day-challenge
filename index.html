<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>21-Day Workout Challenge Tracker</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Define a custom purple palette
                        'primary-purple': '#8B5CF6', // A vibrant purple
                        'primary-purple-dark': '#7C3AED', // Slightly darker for hover
                        'secondary-purple': '#A78BFA', // Lighter purple for accents
                        'completed-day': '#8B5CF6', // The new completed color
                        'completed-shadow': '#a78bfa', // Shadow for completed days
                    }
                }
            }
        }
    </script>
    <!-- Use Inter font --><style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-100 to-purple-100 min-h-screen flex items-center justify-center p-4">
    <div id="app" class="w-full max-w-lg bg-white shadow-2xl rounded-xl p-6 md:p-8">
        <!-- Dynamic Title Display -->
        <h1 id="challenge-title-display" class="text-3xl font-extrabold text-gray-900 mb-2 text-center">21-Day Challenge</h1>
        <p class="text-center text-sm text-secondary-purple font-medium mb-6">Track your journey to a new habit!</p>

        <!-- Loading/Error Indicator --><div id="status" class="text-center mb-4 text-sm font-medium text-gray-500">
            Loading local challenge data...
        </div>

        <!-- Setup Form (Hidden by default) --><div id="setup-container" class="space-y-4 p-4 border-2 border-dashed border-primary-purple rounded-lg hidden">
            <h2 class="text-xl font-semibold text-gray-800">Challenge Setup</h2>
            
            <!-- New Challenge Title Input -->
            <div class="space-y-1">
                <label for="challenge-title" class="block text-sm font-medium text-gray-700">Name Your Challenge (e.g., "Daily Running"):</label>
                <input type="text" id="challenge-title" value="21-Day Challenge" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary-purple focus:border-primary-purple">
            </div>

            <div class="space-y-1">
                <label for="start-date" class="block text-sm font-medium text-gray-700">Select Challenge Start Date:</label>
                <input type="date" id="start-date" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary-purple focus:border-primary-purple">
            </div>
            <div id="end-date-display" class="text-sm text-gray-600">
                The challenge will run for 21 days.
            </div>
            <button id="start-challenge-btn"
                class="w-full py-2 px-4 bg-primary-purple text-white font-semibold rounded-lg shadow-md hover:bg-primary-purple-dark transition duration-150">
                Start Challenge
            </button>
        </div>

        <!-- Challenge Grid (Hidden by default) --><div id="challenge-container" class="hidden">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 p-3 bg-purple-50 rounded-lg">
                <div class="text-sm font-medium text-gray-700 mb-2 md:mb-0">
                    Challenge Dates: <span id="challenge-dates" class="font-bold text-primary-purple"></span>
                </div>
                <button id="reset-challenge-btn"
                    class="text-xs py-1 px-3 bg-red-100 text-red-600 font-medium rounded-full hover:bg-red-200 transition duration-150">
                    Reset Challenge
                </button>
            </div>
            <div id="challenge-grid" class="grid grid-cols-7 gap-3">
                <!-- Days will be generated here --></div>
            <div id="progress-bar-container" class="mt-6">
                <p class="text-sm font-medium text-gray-700 mb-1">Progress: <span id="progress-text">0%</span></p>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-primary-purple h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Logic (Now using localStorage) --><script>
        
        const CHALLENGE_DAYS = 21;
        const LOCAL_STORAGE_KEY = '21DayChallengeData';

        const statusEl = document.getElementById('status');
        const setupContainer = document.getElementById('setup-container');
        const challengeContainer = document.getElementById('challenge-container');
        const challengeGrid = document.getElementById('challenge-grid');
        const startDateInput = document.getElementById('start-date');
        const endDateDisplay = document.getElementById('end-date-display');
        const startDateBtn = document.getElementById('start-challenge-btn');
        const resetBtn = document.getElementById('reset-challenge-btn');
        const challengeDatesEl = document.getElementById('challenge-dates');
        const progressBar = document.getElementById('progress-bar');
        const progressTextEl = document.getElementById('progress-text');
        const challengeTitleInput = document.getElementById('challenge-title');
        const challengeTitleDisplay = document.getElementById('challenge-title-display');


        // --- Utility Functions ---

        /**
         * Formats a Date object to YYYY-MM-DD string.
         * @param {Date} date
         * @returns {string}
         */
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * Adds days to a Date object.
         * @param {Date} date
         * @param {number} days
         * @returns {Date}
         */
        function addDays(date, days) {
            const newDate = new Date(date);
            newDate.setDate(newDate.getDate() + days);
            return newDate;
        }
        
        /**
         * Gets the abbreviated day name for a Date object.
         * @param {Date} date
         * @returns {string} (e.g., 'Sun', 'Mon')
         */
        function getDayName(date) {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            return days[date.getDay()];
        }


        /**
         * Calculates the end date and generates the 21-day map.
         * @param {string} startDateString - YYYY-MM-DD
         * @param {string} title - The challenge title
         * @param {Object<string, boolean>} [existingCompletedDays={}]
         * @returns {{title: string, startDate: string, endDate: string, completedDays: Object<string, boolean>}}
         */
        function createChallengeData(startDateString, title, existingCompletedDays = {}) {
            // Parse date parts to create a local date
            const parts = startDateString.split('-');
            const startDate = new Date(parts[0], parts[1] - 1, parts[2]); 
            
            const endDate = addDays(startDate, CHALLENGE_DAYS - 1);
            const challengeData = {
                title: title,
                startDate: startDateString,
                endDate: formatDate(endDate),
                completedDays: {}
            };

            for (let i = 0; i < CHALLENGE_DAYS; i++) {
                const dayDate = addDays(startDate, i);
                const dayDateString = formatDate(dayDate);
                // Preserve existing completion status if available
                challengeData.completedDays[dayDateString] = existingCompletedDays[dayDateString] || false;
            }

            return challengeData;
        }

        // --- Local Storage Logic ---

        /**
         * Loads challenge data from localStorage.
         * @returns {Object|null}
         */
        function loadLocalData() {
            const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedData) {
                try {
                    return JSON.parse(storedData);
                } catch (e) {
                    console.error("Error parsing stored data:", e);
                    return null;
                }
            }
            return null;
        }
        
        /**
         * Saves challenge data to localStorage and triggers a UI update.
         * @param {Object} data - The full challenge data object
         */
        function saveLocalData(data) {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
                console.log("Challenge configuration saved locally.");
                checkAndRender(); // Re-render the UI immediately
            } catch (error) {
                console.error("Error saving challenge configuration:", error);
                statusEl.textContent = "Error saving data locally. Check browser permissions.";
            }
        }

        /**
         * Updates the completion status for a specific day.
         * @param {string} dateString - YYYY-MM-DD
         * @param {boolean} isCompleted
         */
        async function updateDayCompletion(dateString, isCompleted) {
            try {
                const storedData = loadLocalData(); 
                if (!storedData) {
                    console.warn("Attempted to update day but no stored data found.");
                    return;
                }

                // Make the modification
                storedData.completedDays[dateString] = isCompleted;

                // Save and re-render
                saveLocalData(storedData); 

                console.log(`Day ${dateString} updated to ${isCompleted}`);
            } catch (error) {
                console.error("Error updating day completion:", error);
                statusEl.textContent = "Error updating completion locally.";
            }
        }


        // --- Rendering and App State ---

        /**
         * Renders the challenge grid based on the provided data.
         * @param {{title: string, startDate: string, endDate: string, completedDays: Object<string, boolean>}} challengeData
         */
        function renderChallenge(challengeData) {
            challengeGrid.innerHTML = '';
            const { title, startDate, endDate, completedDays } = challengeData;
            let completedCount = 0;

            // Display the custom challenge title
            challengeTitleDisplay.textContent = title; 
            challengeDatesEl.textContent = `${startDate} - ${endDate}`;
            challengeContainer.classList.remove('hidden');
            setupContainer.classList.add('hidden');
            statusEl.textContent = "Challenge is active and saved locally!";

            // Use the safe date parsing here for rendering too
            const parts = startDate.split('-');
            const startDateObj = new Date(parts[0], parts[1] - 1, parts[2]);

            for (let i = 0; i < CHALLENGE_DAYS; i++) {
                const dayDate = addDays(startDateObj, i);
                const dayDateString = formatDate(dayDate);
                const dayName = getDayName(dayDate); // Get the day of the week
                const isCompleted = completedDays[dayDateString] || false;
                const dayNumber = i + 1;

                if (isCompleted) {
                    completedCount++;
                }

                // Day Card Element
                const dayCard = document.createElement('div');
                dayCard.className = `p-2 flex flex-col items-center justify-between rounded-xl shadow-md cursor-pointer transition-all duration-300 transform hover:scale-[1.02] ${
                    isCompleted ? 'bg-completed-day text-white shadow-completed-shadow/50' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'
                }`;
                dayCard.dataset.date = dayDateString;

                // Day Number and Day Name
                dayCard.innerHTML = `
                    <div class="text-sm font-bold">Day ${dayNumber}</div>
                    <div class="text-xs ${isCompleted ? 'text-white/80' : 'text-gray-500'}">${dayName}</div>
                    <div class="mt-1 text-2xl">
                        ${isCompleted ? '&#10003;' : '&#9633;'}
                    </div>
                `;

                // Click handler to toggle completion
                dayCard.addEventListener('click', () => {
                    const newStatus = !isCompleted;
                    updateDayCompletion(dayDateString, newStatus);
                });

                challengeGrid.appendChild(dayCard);
            }

            // Update Progress Bar
            const progressPercentage = Math.round((completedCount / CHALLENGE_DAYS) * 100);
            progressBar.style.width = `${progressPercentage}%`;
            progressTextEl.textContent = `${progressPercentage}% (${completedCount}/${CHALLENGE_DAYS} days)`;
        }
        
        /**
         * Checks for local data and renders the correct view (Challenge or Setup).
         */
        function checkAndRender() {
            const data = loadLocalData();
            if (data) {
                renderChallenge(data);
            } else {
                setupContainer.classList.remove('hidden');
                challengeContainer.classList.add('hidden');
                statusEl.textContent = "Please set your challenge start date.";
                challengeTitleDisplay.textContent = "21-Day Challenge"; // Reset title on setup screen
            }
        }


        // --- Event Handlers ---

        function updateEndDateDisplay() {
            const startDateString = startDateInput.value;
            if (startDateString) {
                const parts = startDateString.split('-');
                const startDate = new Date(parts[0], parts[1] - 1, parts[2]); // Safe local date parsing
                const endDate = addDays(startDate, CHALLENGE_DAYS - 1);
                endDateDisplay.innerHTML = `Challenge End Date: <span class="font-semibold">${formatDate(endDate)}</span>`;
            } else {
                endDateDisplay.textContent = `The challenge will run for ${CHALLENGE_DAYS} days.`;
            }
        }

        startDateInput.addEventListener('change', updateEndDateDisplay);
        window.addEventListener('load', updateEndDateDisplay);

        startDateBtn.addEventListener('click', () => {
            const startDateString = startDateInput.value;
            const challengeTitle = challengeTitleInput.value.trim() || '21-Day Challenge'; 
            
            if (!startDateString) {
                statusEl.textContent = "Please select a valid start date!";
                return;
            }

            // Create new data and save it, which triggers rendering
            const newChallengeData = createChallengeData(startDateString, challengeTitle); 
            saveLocalData(newChallengeData);
        });

        resetBtn.addEventListener('click', async () => {
            if (await confirm("Are you sure you want to reset and delete your current challenge progress? This action cannot be undone.")) {
                 try {
                    localStorage.removeItem(LOCAL_STORAGE_KEY);
                    statusEl.textContent = "Challenge reset. Please set your challenge start date.";
                    console.log("Challenge reset and local data deleted.");
                    startDateInput.value = '';
                    updateEndDateDisplay();
                    checkAndRender(); // Revert to setup screen
                } catch (e) {
                    console.error("Failed to reset challenge:", e);
                    statusEl.textContent = "Failed to reset challenge.";
                }
            }
        });

        // Handle browser confirmation via custom modal logic instead of native alert/confirm
        function confirm(message) {
            return new Promise((resolve) => {
                // Create minimal confirmation dialog
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl w-80">
                        <p class="text-gray-700 mb-4">${message}</p>
                        <div class="flex justify-end space-x-3">
                            <button id="modal-cancel" class="py-1 px-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100">Cancel</button>
                            <button id="modal-ok" class="py-1 px-3 bg-red-600 text-white rounded-lg hover:bg-red-700">OK</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('modal-ok').onclick = () => {
                    document.body.removeChild(modal);
                    resolve(true);
                };

                document.getElementById('modal-cancel').onclick = () => {
                    document.body.removeChild(modal);
                    resolve(false);
                };
            });
        }

        // --- Initialization ---

        window.onload = checkAndRender;

    </script>
</body>
</html>
